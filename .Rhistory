# Tops
tops <- x
for (i in 1:dim(tops)[1])
{
st_geometry(tops[i,]) <- st_geometry(tops[i,]) + + c(0, as.numeric(x[i,var])[1] * k)
}
# Sort & plot
# faces <-  faces[order(faces[,"pos"])]
ids <- tops[order(tops[,var] %>% st_drop_geometry(), decreasing = FALSE),"id"] %>% st_drop_geometry()
ids <- ids$id
plot(st_geometry(x), add = FALSE)
for (i in ids){
plot(st_geometry(faces[faces$id == i,]), col=faces$fill, border = faces$border, add = TRUE)
plot(st_geometry(tops[i,]), col = fill[1], add = TRUE)
}
message("")
message("Done")
return(faces)
}
x <- deform(states)
f <- extrude(x, "pop2019", k = 0.007, col = "yellow")
f <- extrude(x, "pop2019", k = 0.007, col = "#a84d4d")
# EXTRUDE
# x <- deform(states)
# var = "pop2019"
# k = 0.008
# col = "red"
# add = FALSE
extrude <- function(x, var, k = 0.5, col = "red") {
x <- st_cast(x, "POLYGON", warn = FALSE)
x$id <- row.names(x)
x <- x[,c("id",var)]
v <- x[,var] %>% st_drop_geometry()
x$height <- as.numeric(v[,var] * k)
# Polygons to dots
nodes <- st_cast(x,"POINT", warn = FALSE)
#nodes <- nodes[nodes$id %in% c(1:1),] # enlever
nb <- dim(nodes)[1] - 1
message("Topology Detection")
pct <- 0
for (i in 1:nb){
n <- seq(1, nb, by = round(nb/10,0))
if (i %in% n) {
pct <- pct + 10
message(paste0("[",pct,"%]"), appendLF = FALSE)
}
id1 <- nodes[i,"id"] %>% st_drop_geometry()
id2 <- nodes[i+1,"id"] %>% st_drop_geometry()
x1 <- st_coordinates(nodes[i,])[1]
y1 <- st_coordinates(nodes[i,])[2]
x2 <- st_coordinates(nodes[i+1,])[1]
y2 <- st_coordinates(nodes[i+1,])[2]
pos <- (y1 + y2) / 2
c <- st_sfc(st_point(c(X = (x1 + x2) / 2, Y = (y1 + y2) / 2)))
if (i == 1){
dots <- st_sf(x1 = x1, x2 = x2, y1 = y1, y2 = y2, pos = pos,  geometry=c)
} else {
if (id1 == id2) {
dots <- rbind(dots,st_sf(x1 = x1, x2 = x2, y1 = y1, y2 = y2, pos = pos, geometry=c))
}
}
}
# duplicate suppression
dots$dbl <- duplicated(dots$geometry)
dots <- dots[!dots$dbl,]
# Sort
dots <- dots[order(dots[,"pos"] %>% st_drop_geometry() , decreasing = TRUE),]
# Dots -> faces
test <- st_is_within_distance(dots,x,1)
message("")
message("Extrusion")
pct <- 0
for (i in 1 : dim(dots)[1]){
n <- seq(1, dim(dots)[1], by = round(dim(dots)[1]/10,0))
n <- n[1:length(n)-1]
if (i %in% n) {
pct <- pct + 10
message(paste0("[",pct,"%]"), appendLF = FALSE)
}
tmp1 <- as.numeric(x[test[[i]][1],"height"] %>% st_drop_geometry())
tmp2 <- as.numeric(x[test[[i]][2],"height"] %>% st_drop_geometry())
height1 <- min(tmp1, tmp2)
height2 <- max(tmp1, tmp2, na.rm=TRUE)
if (tmp1 > tmp2 | is.na(tmp2)){
dots$id[i]  <- as.numeric(x[test[[i]][1],"id"])[1]
} else {
dots$id[i] <- as.numeric(x[test[[i]][2],"id"])[1]
}
if(is.na(height1)){height1 <- 0}
dot1 <- c(dots$x1[i],dots$y1[i] + height1)
dot2 <- c(dots$x2[i],dots$y2[i] + height1)
dot3 <- c(dots$x2[i],dots$y2[i] + height2)
dot4 <- c(dots$x1[i],dots$y1[i] + height2)
dots[i,"ang"] <- atan((dot2[2] - dot1[2]) / ( dot2[1] - dot1[1]))*180/pi
st_geometry(dots[i,]) <- st_sfc(st_polygon(list(rbind(dot1, dot2, dot3, dot4, dot1))))
}
faces <- dots
# colors
if(col == "white"){
fill <- c("white","white","white")
border <- c("black","black","black")
} else {
pal <- colorRampPalette(c("white",col,"black"))(11)
fill <- c(col, pal[3],pal[7])
border <- c(pal[9], pal[4],pal[8])
}
faces$fill <- as.character(faces$fill)
faces$fill <- fill[2]
faces$border <- as.character(faces$border)
faces[faces$ang > 0,"fill"] <- fill[3]
faces[faces$ang > 0,"border"] <- border[3]
#faces$border <- border[2]
#faces$border[faces$ang >= 0] <- border[3]
# Tops
tops <- x
for (i in 1:dim(tops)[1])
{
st_geometry(tops[i,]) <- st_geometry(tops[i,]) + + c(0, as.numeric(x[i,var])[1] * k)
}
# Sort & plot
# faces <-  faces[order(faces[,"pos"])]
ids <- tops[order(tops[,var] %>% st_drop_geometry(), decreasing = FALSE),"id"] %>% st_drop_geometry()
ids <- ids$id
plot(st_geometry(x), add = FALSE)
for (i in ids){
plot(st_geometry(faces[faces$id == i,]), col=faces$fill, border = faces$border, add = TRUE)
plot(st_geometry(tops[i,]), col = fill[1], add = TRUE)
}
message("")
message("Done")
return(faces)
}
x <- deform(states)
f <- extrude(x, "pop2019", k = 0.007, col = "#a84d4d")
x <- deform(states)
var = "pop2019"
k = 0.008
col = "red"
x <- st_cast(x, "POLYGON", warn = FALSE)
x$id <- row.names(x)
x <- x[,c("id",var)]
v <- x[,var] %>% st_drop_geometry()
x$height <- as.numeric(v[,var] * k)
nodes <- st_cast(x,"POINT", warn = FALSE)
#nodes <- nodes[nodes$id %in% c(1:1),] # enlever
nb <- dim(nodes)[1] - 1
message("Topology Detection")
pct <- 0
for (i in 1:nb){
n <- seq(1, nb, by = round(nb/10,0))
if (i %in% n) {
pct <- pct + 10
message(paste0("[",pct,"%]"), appendLF = FALSE)
}
id1 <- nodes[i,"id"] %>% st_drop_geometry()
id2 <- nodes[i+1,"id"] %>% st_drop_geometry()
x1 <- st_coordinates(nodes[i,])[1]
y1 <- st_coordinates(nodes[i,])[2]
x2 <- st_coordinates(nodes[i+1,])[1]
y2 <- st_coordinates(nodes[i+1,])[2]
pos <- (y1 + y2) / 2
c <- st_sfc(st_point(c(X = (x1 + x2) / 2, Y = (y1 + y2) / 2)))
if (i == 1){
dots <- st_sf(x1 = x1, x2 = x2, y1 = y1, y2 = y2, pos = pos,  geometry=c)
} else {
if (id1 == id2) {
dots <- rbind(dots,st_sf(x1 = x1, x2 = x2, y1 = y1, y2 = y2, pos = pos, geometry=c))
}
}
}
dots$dbl <- duplicated(dots$geometry)
dots <- dots[!dots$dbl,]
dots <- dots[order(dots[,"pos"] %>% st_drop_geometry() , decreasing = TRUE),]
# Dots -> faces
test <- st_is_within_distance(dots,x,1)
message("")
message("Extrusion")
pct <- 0
for (i in 1 : dim(dots)[1]){
n <- seq(1, dim(dots)[1], by = round(dim(dots)[1]/10,0))
n <- n[1:length(n)-1]
if (i %in% n) {
pct <- pct + 10
message(paste0("[",pct,"%]"), appendLF = FALSE)
}
tmp1 <- as.numeric(x[test[[i]][1],"height"] %>% st_drop_geometry())
tmp2 <- as.numeric(x[test[[i]][2],"height"] %>% st_drop_geometry())
height1 <- min(tmp1, tmp2)
height2 <- max(tmp1, tmp2, na.rm=TRUE)
if (tmp1 > tmp2 | is.na(tmp2)){
dots$id[i]  <- as.numeric(x[test[[i]][1],"id"])[1]
} else {
dots$id[i] <- as.numeric(x[test[[i]][2],"id"])[1]
}
if(is.na(height1)){height1 <- 0}
dot1 <- c(dots$x1[i],dots$y1[i] + height1)
dot2 <- c(dots$x2[i],dots$y2[i] + height1)
dot3 <- c(dots$x2[i],dots$y2[i] + height2)
dot4 <- c(dots$x1[i],dots$y1[i] + height2)
dots[i,"ang"] <- atan((dot2[2] - dot1[2]) / ( dot2[1] - dot1[1]))*180/pi
st_geometry(dots[i,]) <- st_sfc(st_polygon(list(rbind(dot1, dot2, dot3, dot4, dot1))))
}
faces <- dots
if(col == "white"){
fill <- c("white","white","white")
border <- c("black","black","black")
} else {
pal <- colorRampPalette(c("white",col,"black"))(11)
fill <- c(col, pal[3],pal[7])
border <- c(pal[9], pal[4],pal[8])
}
View(faces)
faces$fill <- fill[2]
View(faces)
faces[faces$ang > 0,"fill"] <- fill[3]
View(faces)
# EXTRUDE
# x <- deform(states)
# var = "pop2019"
# k = 0.008
# col = "red"
extrude <- function(x, var, k = 0.5, col = "red") {
x <- st_cast(x, "POLYGON", warn = FALSE)
x$id <- row.names(x)
x <- x[,c("id",var)]
v <- x[,var] %>% st_drop_geometry()
x$height <- as.numeric(v[,var] * k)
# Polygons to dots
nodes <- st_cast(x,"POINT", warn = FALSE)
#nodes <- nodes[nodes$id %in% c(1:1),] # enlever
nb <- dim(nodes)[1] - 1
message("Topology Detection")
pct <- 0
for (i in 1:nb){
n <- seq(1, nb, by = round(nb/10,0))
if (i %in% n) {
pct <- pct + 10
message(paste0("[",pct,"%]"), appendLF = FALSE)
}
id1 <- nodes[i,"id"] %>% st_drop_geometry()
id2 <- nodes[i+1,"id"] %>% st_drop_geometry()
x1 <- st_coordinates(nodes[i,])[1]
y1 <- st_coordinates(nodes[i,])[2]
x2 <- st_coordinates(nodes[i+1,])[1]
y2 <- st_coordinates(nodes[i+1,])[2]
pos <- (y1 + y2) / 2
c <- st_sfc(st_point(c(X = (x1 + x2) / 2, Y = (y1 + y2) / 2)))
if (i == 1){
dots <- st_sf(x1 = x1, x2 = x2, y1 = y1, y2 = y2, pos = pos,  geometry=c)
} else {
if (id1 == id2) {
dots <- rbind(dots,st_sf(x1 = x1, x2 = x2, y1 = y1, y2 = y2, pos = pos, geometry=c))
}
}
}
# duplicate suppression
dots$dbl <- duplicated(dots$geometry)
dots <- dots[!dots$dbl,]
# Sort
dots <- dots[order(dots[,"pos"] %>% st_drop_geometry() , decreasing = TRUE),]
# Dots -> faces
test <- st_is_within_distance(dots,x,1)
message("")
message("Extrusion")
pct <- 0
for (i in 1 : dim(dots)[1]){
n <- seq(1, dim(dots)[1], by = round(dim(dots)[1]/10,0))
n <- n[1:length(n)-1]
if (i %in% n) {
pct <- pct + 10
message(paste0("[",pct,"%]"), appendLF = FALSE)
}
tmp1 <- as.numeric(x[test[[i]][1],"height"] %>% st_drop_geometry())
tmp2 <- as.numeric(x[test[[i]][2],"height"] %>% st_drop_geometry())
height1 <- min(tmp1, tmp2)
height2 <- max(tmp1, tmp2, na.rm=TRUE)
if (tmp1 > tmp2 | is.na(tmp2)){
dots$id[i]  <- as.numeric(x[test[[i]][1],"id"])[1]
} else {
dots$id[i] <- as.numeric(x[test[[i]][2],"id"])[1]
}
if(is.na(height1)){height1 <- 0}
dot1 <- c(dots$x1[i],dots$y1[i] + height1)
dot2 <- c(dots$x2[i],dots$y2[i] + height1)
dot3 <- c(dots$x2[i],dots$y2[i] + height2)
dot4 <- c(dots$x1[i],dots$y1[i] + height2)
dots[i,"ang"] <- atan((dot2[2] - dot1[2]) / ( dot2[1] - dot1[1]))*180/pi
st_geometry(dots[i,]) <- st_sfc(st_polygon(list(rbind(dot1, dot2, dot3, dot4, dot1))))
}
faces <- dots
# colors
if(col == "white"){
fill <- c("white","white","white")
border <- c("black","black","black")
} else {
pal <- colorRampPalette(c("white",col,"black"))(11)
fill <- c(col, pal[3],pal[7])
border <- c(pal[9], pal[4],pal[8])
}
View(faces)
faces$fill <- fill[2]
faces[faces$ang > 0,"fill"] <- fill[3]
faces$border <- as.character(faces$border)
faces[faces$ang > 0,"border"] <- border[3]
# Tops
tops <- x
for (i in 1:dim(tops)[1])
{
st_geometry(tops[i,]) <- st_geometry(tops[i,]) + + c(0, as.numeric(x[i,var])[1] * k)
}
# Sort & plot
# faces <-  faces[order(faces[,"pos"])]
ids <- tops[order(tops[,var] %>% st_drop_geometry(), decreasing = FALSE),"id"] %>% st_drop_geometry()
ids <- ids$id
plot(st_geometry(x), add = FALSE)
for (i in ids){
plot(st_geometry(faces[faces$id == i,]), col=faces$fill[faces$id == i], border = faces$border, add = TRUE)
plot(st_geometry(tops[i,]), col = fill[1], add = TRUE)
}
message("")
message("Done")
return(faces)
}
x <- deform(states)
f <- extrude(x, "pop2019", k = 0.007, col = "#a84d4d")
x <- deform(states)
var = "pop2019"
k = 0.008
col = "red"
x <- st_cast(x, "POLYGON", warn = FALSE)
x$id <- row.names(x)
x <- x[,c("id",var)]
v <- x[,var] %>% st_drop_geometry()
x$height <- as.numeric(v[,var] * k)
nodes <- st_cast(x,"POINT", warn = FALSE)
#nodes <- nodes[nodes$id %in% c(1:1),] # enlever
nb <- dim(nodes)[1] - 1
message("Topology Detection")
pct <- 0
for (i in 1:nb){
n <- seq(1, nb, by = round(nb/10,0))
if (i %in% n) {
pct <- pct + 10
message(paste0("[",pct,"%]"), appendLF = FALSE)
}
id1 <- nodes[i,"id"] %>% st_drop_geometry()
id2 <- nodes[i+1,"id"] %>% st_drop_geometry()
x1 <- st_coordinates(nodes[i,])[1]
y1 <- st_coordinates(nodes[i,])[2]
x2 <- st_coordinates(nodes[i+1,])[1]
y2 <- st_coordinates(nodes[i+1,])[2]
pos <- (y1 + y2) / 2
c <- st_sfc(st_point(c(X = (x1 + x2) / 2, Y = (y1 + y2) / 2)))
if (i == 1){
dots <- st_sf(x1 = x1, x2 = x2, y1 = y1, y2 = y2, pos = pos,  geometry=c)
} else {
if (id1 == id2) {
dots <- rbind(dots,st_sf(x1 = x1, x2 = x2, y1 = y1, y2 = y2, pos = pos, geometry=c))
}
}
}
dots$dbl <- duplicated(dots$geometry)
dots <- dots[!dots$dbl,]
dots <- dots[order(dots[,"pos"] %>% st_drop_geometry() , decreasing = TRUE),]
# Dots -> faces
test <- st_is_within_distance(dots,x,1)
message("")
message("Extrusion")
pct <- 0
for (i in 1 : dim(dots)[1]){
n <- seq(1, dim(dots)[1], by = round(dim(dots)[1]/10,0))
n <- n[1:length(n)-1]
if (i %in% n) {
pct <- pct + 10
message(paste0("[",pct,"%]"), appendLF = FALSE)
}
tmp1 <- as.numeric(x[test[[i]][1],"height"] %>% st_drop_geometry())
tmp2 <- as.numeric(x[test[[i]][2],"height"] %>% st_drop_geometry())
height1 <- min(tmp1, tmp2)
height2 <- max(tmp1, tmp2, na.rm=TRUE)
if (tmp1 > tmp2 | is.na(tmp2)){
dots$id[i]  <- as.numeric(x[test[[i]][1],"id"])[1]
} else {
dots$id[i] <- as.numeric(x[test[[i]][2],"id"])[1]
}
if(is.na(height1)){height1 <- 0}
dot1 <- c(dots$x1[i],dots$y1[i] + height1)
dot2 <- c(dots$x2[i],dots$y2[i] + height1)
dot3 <- c(dots$x2[i],dots$y2[i] + height2)
dot4 <- c(dots$x1[i],dots$y1[i] + height2)
dots[i,"ang"] <- atan((dot2[2] - dot1[2]) / ( dot2[1] - dot1[1]))*180/pi
st_geometry(dots[i,]) <- st_sfc(st_polygon(list(rbind(dot1, dot2, dot3, dot4, dot1))))
}
faces <- dots
if(col == "white"){
fill <- c("white","white","white")
border <- c("black","black","black")
} else {
pal <- colorRampPalette(c("white",col,"black"))(11)
fill <- c(col, pal[3],pal[7])
border <- c(pal[9], pal[4],pal[8])
}
View(faces)
faces$fill <- fill[2]
faces[faces$ang > 0,"fill"] <- fill[3]
faces$border <- as.character(faces$border)
faces$border <- border[2]
faces[faces$ang > 0,"border"] <- border[3]
extrude <- function(x, var, k = 0.5, col = "red") {
x <- st_cast(x, "POLYGON", warn = FALSE)
x$id <- row.names(x)
x <- x[,c("id",var)]
v <- x[,var] %>% st_drop_geometry()
x$height <- as.numeric(v[,var] * k)
# Polygons to dots
nodes <- st_cast(x,"POINT", warn = FALSE)
#nodes <- nodes[nodes$id %in% c(1:1),] # enlever
nb <- dim(nodes)[1] - 1
message("Topology Detection")
pct <- 0
for (i in 1:nb){
n <- seq(1, nb, by = round(nb/10,0))
if (i %in% n) {
pct <- pct + 10
message(paste0("[",pct,"%]"), appendLF = FALSE)
}
id1 <- nodes[i,"id"] %>% st_drop_geometry()
id2 <- nodes[i+1,"id"] %>% st_drop_geometry()
x1 <- st_coordinates(nodes[i,])[1]
y1 <- st_coordinates(nodes[i,])[2]
x2 <- st_coordinates(nodes[i+1,])[1]
y2 <- st_coordinates(nodes[i+1,])[2]
pos <- (y1 + y2) / 2
c <- st_sfc(st_point(c(X = (x1 + x2) / 2, Y = (y1 + y2) / 2)))
if (i == 1){
dots <- st_sf(x1 = x1, x2 = x2, y1 = y1, y2 = y2, pos = pos,  geometry=c)
} else {
if (id1 == id2) {
dots <- rbind(dots,st_sf(x1 = x1, x2 = x2, y1 = y1, y2 = y2, pos = pos, geometry=c))
}
}
}
# duplicate suppression
dots$dbl <- duplicated(dots$geometry)
dots <- dots[!dots$dbl,]
# Sort
dots <- dots[order(dots[,"pos"] %>% st_drop_geometry() , decreasing = TRUE),]
# Dots -> faces
test <- st_is_within_distance(dots,x,1)
message("")
message("Extrusion")
pct <- 0
for (i in 1 : dim(dots)[1]){
n <- seq(1, dim(dots)[1], by = round(dim(dots)[1]/10,0))
n <- n[1:length(n)-1]
if (i %in% n) {
pct <- pct + 10
message(paste0("[",pct,"%]"), appendLF = FALSE)
}
tmp1 <- as.numeric(x[test[[i]][1],"height"] %>% st_drop_geometry())
tmp2 <- as.numeric(x[test[[i]][2],"height"] %>% st_drop_geometry())
height1 <- min(tmp1, tmp2)
height2 <- max(tmp1, tmp2, na.rm=TRUE)
if (tmp1 > tmp2 | is.na(tmp2)){
dots$id[i]  <- as.numeric(x[test[[i]][1],"id"])[1]
} else {
dots$id[i] <- as.numeric(x[test[[i]][2],"id"])[1]
}
if(is.na(height1)){height1 <- 0}
dot1 <- c(dots$x1[i],dots$y1[i] + height1)
dot2 <- c(dots$x2[i],dots$y2[i] + height1)
dot3 <- c(dots$x2[i],dots$y2[i] + height2)
dot4 <- c(dots$x1[i],dots$y1[i] + height2)
dots[i,"ang"] <- atan((dot2[2] - dot1[2]) / ( dot2[1] - dot1[1]))*180/pi
st_geometry(dots[i,]) <- st_sfc(st_polygon(list(rbind(dot1, dot2, dot3, dot4, dot1))))
}
faces <- dots
# colors
if(col == "white"){
fill <- c("white","white","white")
border <- c("black","black","black")
} else {
pal <- colorRampPalette(c("white",col,"black"))(11)
fill <- c(col, pal[3],pal[7])
border <- c(pal[9], pal[4],pal[8])
}
faces$fill <- fill[2]
faces[faces$ang > 0,"fill"] <- fill[3]
faces$border <- border[2]
faces[faces$ang > 0,"border"] <- border[3]
# Tops
tops <- x
for (i in 1:dim(tops)[1])
{
st_geometry(tops[i,]) <- st_geometry(tops[i,]) + + c(0, as.numeric(x[i,var])[1] * k)
}
# Sort & plot
# faces <-  faces[order(faces[,"pos"])]
ids <- tops[order(tops[,var] %>% st_drop_geometry(), decreasing = FALSE),"id"] %>% st_drop_geometry()
ids <- ids$id
plot(st_geometry(x), add = FALSE)
for (i in ids){
plot(st_geometry(faces[faces$id == i,]), col=faces$fill[faces$id == i], border = faces$border, add = TRUE)
plot(st_geometry(tops[i,]), col = fill[1], add = TRUE)
}
message("")
message("Done")
return(faces)
}
x <- deform(states)
f <- extrude(x, "pop2019", k = 0.007, col = "#a84d4d")
f <- extrude(x, "pop2019", k = 0.007, col = "white")
